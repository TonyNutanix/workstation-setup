---
# =============================================================================
# Deploy Rocky Linux 9 VM on Nutanix AHV
# =============================================================================
# Requirements:
#   - Ansible >= 2.14
#   - nutanix.ncp collection >= 1.9.0
#     Install: ansible-galaxy collection install nutanix.ncp
#   - A Rocky Linux 9 disk image already uploaded to Nutanix Image Service
#     (or use the image upload play below first)
#
# Usage:
#   ansible-playbook deploy_rocky9_vm.yml -e "@vars/nutanix_credentials.yml"
#
#   Or with ansible-vault encrypted credentials:
#   ansible-playbook deploy_rocky9_vm.yml \
#     -e "@vars/nutanix_credentials.yml" --ask-vault-pass
# =============================================================================

- name: Deploy Rocky Linux 9 VM on Nutanix AHV
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vars/vm_config.yml

  # -------------------------------------------------------------------------
  # Pre-flight checks
  # -------------------------------------------------------------------------
  pre_tasks:
    - name: Validate required credentials are defined
      ansible.builtin.assert:
        that:
          - nutanix_host is defined and nutanix_host | length > 0
          - nutanix_username is defined and nutanix_username | length > 0
          - nutanix_password is defined and nutanix_password | length > 0
        fail_msg: >
          Missing Nutanix credentials. Provide them via:
            -e "@vars/nutanix_credentials.yml"
        success_msg: "Nutanix credentials validated."

    - name: Validate VM configuration parameters
      ansible.builtin.assert:
        that:
          - vm_name is defined and vm_name | length > 0
          - vm_vcpus | int > 0
          - vm_memory_gb | int > 0
          - vm_disk_size_gb | int > 0
          - nutanix_cluster_name is defined
          - nutanix_subnet_name is defined
          - rocky9_image_name is defined
        fail_msg: "One or more VM configuration parameters are missing or invalid."
        success_msg: "VM configuration validated."

  tasks:
    # -----------------------------------------------------------------------
    # Optional: Upload Rocky 9 image if it doesn't exist yet
    # -----------------------------------------------------------------------
    - name: Upload Rocky Linux 9 cloud image (if source URL provided)
      nutanix.ncp.ntnx_images:
        state: present
        nutanix_host: "{{ nutanix_host }}"
        nutanix_username: "{{ nutanix_username }}"
        nutanix_password: "{{ nutanix_password }}"
        validate_certs: "{{ nutanix_validate_certs | default(false) }}"
        name: "{{ rocky9_image_name }}"
        desc: "Rocky Linux 9 Generic Cloud - deployed via Ansible"
        image_type: DISK_IMAGE
        source_url: "{{ rocky9_image_url }}"
        clusters:
          - name: "{{ nutanix_cluster_name }}"
        wait: true
      when: rocky9_image_url is defined and rocky9_image_url | length > 0
      register: image_upload
      tags:
        - image

    - name: Display image upload result
      ansible.builtin.debug:
        msg: "Image '{{ rocky9_image_name }}' is ready."
      when: image_upload is not skipped
      tags:
        - image

    # -----------------------------------------------------------------------
    # Generate cloud-init user data
    # -----------------------------------------------------------------------
    - name: Generate cloud-init user data
      ansible.builtin.set_fact:
        cloud_init_userdata: |
          #cloud-config
          hostname: {{ vm_hostname | default(vm_name) }}
          fqdn: {{ vm_fqdn | default(vm_name ~ '.' ~ vm_domain | default('local')) }}
          manage_etc_hosts: true
          ssh_pwauth: {{ cloud_init_ssh_pwauth | default('false') }}

          users:
            - name: {{ cloud_init_user | default('ansible') }}
              groups: wheel
              sudo: ALL=(ALL) NOPASSWD:ALL
              shell: /bin/bash
              lock_passwd: false
              ssh_authorized_keys:
                - {{ cloud_init_ssh_pubkey }}

          packages:
            - qemu-guest-agent
            - cloud-utils-growpart
            - bash-completion
            - vim-enhanced

          runcmd:
            - systemctl enable --now qemu-guest-agent
            - growpart /dev/sda 1 || true
            - xfs_growfs / || resize2fs /dev/sda1 || true

          final_message: "Rocky Linux 9 VM provisioned by Ansible in $UPTIME seconds."
      when: cloud_init_ssh_pubkey is defined and cloud_init_ssh_pubkey | length > 0
      tags:
        - vm

    # -----------------------------------------------------------------------
    # Create the VM
    # -----------------------------------------------------------------------
    - name: Create Rocky Linux 9 VM
      nutanix.ncp.ntnx_vms:
        state: present
        nutanix_host: "{{ nutanix_host }}"
        nutanix_username: "{{ nutanix_username }}"
        nutanix_password: "{{ nutanix_password }}"
        validate_certs: "{{ nutanix_validate_certs | default(false) }}"
        name: "{{ vm_name }}"
        desc: "{{ vm_description | default('Rocky Linux 9 VM - deployed via Ansible') }}"
        categories: "{{ vm_categories | default(omit) }}"
        cluster:
          name: "{{ nutanix_cluster_name }}"
        vcpus: "{{ vm_vcpus | int }}"
        cores_per_vcpu: "{{ vm_cores_per_vcpu | default(1) | int }}"
        memory_gb: "{{ vm_memory_gb | int }}"
        networks:
          - is_connected: true
            subnet:
              name: "{{ nutanix_subnet_name }}"
            ip_address: "{{ vm_static_ip | default(omit) }}"
        disks:
          - type: DISK
            size_gb: "{{ vm_disk_size_gb | int }}"
            bus: SCSI
            clone_image:
              name: "{{ rocky9_image_name }}"
          - type: CDROM
            bus: SATA
            empty_cdrom: true
        boot_config:
          boot_type: "{{ vm_boot_type | default('LEGACY') }}"
          boot_order:
            - DISK
            - CDROM
            - NETWORK
        guest_customization:
          type: cloud_init
          script_path: ""
          userdata: "{{ cloud_init_userdata | default(omit) }}"
        timezone: "{{ vm_timezone | default('UTC') }}"
        wait: true
      register: vm_result
      tags:
        - vm

    # -----------------------------------------------------------------------
    # Power on the VM
    # -----------------------------------------------------------------------
    - name: Power on the VM
      nutanix.ncp.ntnx_vms:
        state: present
        nutanix_host: "{{ nutanix_host }}"
        nutanix_username: "{{ nutanix_username }}"
        nutanix_password: "{{ nutanix_password }}"
        validate_certs: "{{ nutanix_validate_certs | default(false) }}"
        vm_uuid: "{{ vm_result.vm_uuid }}"
        force_power_state: "ON"
      when: vm_result is changed
      tags:
        - vm

    # -----------------------------------------------------------------------
    # Output summary
    # -----------------------------------------------------------------------
    - name: Display VM deployment summary
      ansible.builtin.debug:
        msg:
          - "============================================="
          - "  VM Deployment Complete"
          - "============================================="
          - "  Name:       {{ vm_name }}"
          - "  UUID:       {{ vm_result.vm_uuid }}"
          - "  vCPUs:      {{ vm_vcpus }}"
          - "  Memory:     {{ vm_memory_gb }} GB"
          - "  Disk:       {{ vm_disk_size_gb }} GB"
          - "  Cluster:    {{ nutanix_cluster_name }}"
          - "  Subnet:     {{ nutanix_subnet_name }}"
          - "  IP:         {{ vm_static_ip | default('DHCP') }}"
          - "============================================="
      tags:
        - vm
